id: add-machine
namespace: home.lab

inputs:

  - id: vm_name
    type: STRING
    defaults:
      - vm100

  - id: vm_id
    type: INT
    required: true
    defaults:
      - 100

  - id: vm_os_name
    type: ENUM
    required: true
    values:
      - Debian11-Image

  - id: vm_cores
    type: INT
    required: true
    defaults:
      - 1

  - id: vm_memory
    type: STRING
    required: true
    defaults:
      - '1024'

  - id: vm_ipv4
    type: STRING
    required: true
    defaults:
      - 'dhcp'
      
tasks:

  - id: setup
    type: io.kestra.core.tasks.flows.WorkingDirectory
    tasks:

      - id: local_files
        type: io.kestra.core.tasks.storages.LocalFiles
        inputs:
          new-machine.yml: |
              - name: {{ inputs.vm_name }}
                vmid: {{ inputs.vm_id }}
                node: [pve default]
                os_file: {{ inputs.vm_os_name }}
                cores: {{ inputs.vm_cores }}
                memory: {{ inputs.vm_memory }}
                vlan: 1
                ipv4mode: static
                ipv4_address: {{ inputs.vm_ipv4 }}
                ipv4_gateway: 192.168.102.254
                state: new 

      - id: move_file
        type: io.kestra.plugin.scripts.shell.Commands
        commands:
          - mv new-machine.yml dynamic/machines/{{ inputs.vm_os_name }}.yml