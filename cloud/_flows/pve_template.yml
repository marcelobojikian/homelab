id: pve_template
namespace: home.lab.cloud

description: |
  Depending on the value passed as the input, the will flow branch to different tasks.
  If no matching value, the `defaults` task is used.

inputs:

  - id: ostemplate
    type: STRING
    description: "OS create to be a template"
    required: true
    defaults:
      - noble-ubuntu-template.img

  - id: template.name
    type: STRING
    description: "Template name"
    required: true
    defaults:
      - noble-template

  - id: template.cores
    type: INT
    description: "Template number cores"
    required: true
    defaults:
      - 1

  - id: template.memory
    type: STRING
    description: "Template size Memory (MB)"
    required: true
    defaults:
      - 1024

  - id: template.hd
    type: INT
    description: "Template size HD (GB)"
    required: true
    defaults:
      - 16

tasks:

  - id: hello
    type: io.kestra.core.tasks.log.Log
    message: Download servidor {{ inputs.template.name }}

  - id: setup
    type: io.kestra.core.tasks.flows.WorkingDirectory
    tasks:

      - id: local_files
        type: io.kestra.core.tasks.storages.LocalFiles
        inputs:
          kestrabook.yml: |
            ---            
            - hosts: localhost
              tasks:

                - name: Create new VM with minimal options
                  community.general.proxmox_kvm:
                    node: pve
                    api_host: {{ envs.pve_host }}
                    api_user: teste@pve
                    api_password: teste
                    vmid: 9999
                    name: {{ inputs.template.name }}
                    cores: {{ inputs.template.cores }}
                    memory: {{ inputs.template.memory }}
                    scsihw: virtio-scsi-pci
                    net:
                      net0: 'virtio,bridge=vmbr0'
                    ipconfig:
                      ipconfig0: 'ip=dhcp'
                    serial:
                      serial0: socket
                    vga: serial0
                    ide:
                      ide2: 'local-lvm:cloudinit'
                    agent: 1

                - name: Create new disk in VM with the image (root)
                  community.general.proxmox_disk:
                    api_host: {{ envs.pve_host }}
                    api_user: root@pam
                    api_password: {{ secret('PVE_PASS') }}
                    vmid: 9999
                    disk: scsi0
                    import_from: /var/lib/vz/template/iso/{{ inputs.ostemplate }}
                    storage: local-lvm

                - name: Update VM configuration to boot in cloud
                  community.general.proxmox_kvm:
                    api_host: {{ envs.pve_host }}
                    api_user: teste@pve
                    api_password: teste
                    vmid: 9999
                    node: pve
                    boot: c
                    bootdisk: scsi0
                    update: true

                - name: Grow existing disk
                  community.general.proxmox_disk:
                    api_host: {{ envs.pve_host }}
                    api_user: teste@pve
                    api_password: teste
                    vmid: 9999
                    disk: scsi0
                    size: "{{ inputs.template.hd }}G"
                    state: resized

                - name: Convert VM to template
                  community.general.proxmox_kvm:
                    node: pve
                    api_host: {{ envs.pve_host }}
                    api_user: teste@pve
                    api_password: teste
                    vmid: 9999
                    state: template

      - id: ansible_task
        type: io.kestra.plugin.ansible.cli.AnsibleCLI
        docker:
          image: cytopia/ansible:latest-tools
        env:
          ANSIBLE_HOST_KEY_CHECKING: "False"
        commands:
          - apk add --update sshpass
          - pip install proxmoxer==2.0.1
          - pip install requests==2.31.0
          - ansible-playbook kestrabook.yml